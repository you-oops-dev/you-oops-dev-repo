# Maintainer: Your Name <youremail@domain.com>

_NAME_ACCOUNT_GITHUB=you-oops-dev
pkgname=amneziawg-tools
pkgver=1.5
pkgrel=1
pkgdesc="VPN amnezia WireGuard tools"
arch=('any')
url="https://github.com/${_NAME_ACCOUNT_GITHUB}/amneziawg-tools"
license=('GPL')
depends=('bash')
makedepends=('git' 'make' 'gcc' 'patch')
optdepends=('openresolv: for DNS functionality')
options=('strip')
source=("${pkgname}::git+${url}.git"
    "config.exemple"
    "wg-quick.target.patch"
    "wg-quick.service.patch"
    "linux.bash.patch")

sha256sums=('SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
	          'SKIP')

prepare() {
    local src
    for src in "${source[@]}"; do
        src="${src%%::*}"
        src="${src##*/}"
        [[ $src = *.patch ]] || continue
        echo "Applying patch $src..."
        patch -Np1 < "../$src"
    done
}

build() {
  cd ${srcdir}/${pkgname}

	make -s -j$(nproc) -C src/ \
    DESTDIR="${pkgdir}/" \
    WITH_BASHCOMPLETION=yes \
                WITH_WGQUICK=yes \
                WITH_SYSTEMDUNITS=yes
}

package() {
  install -Dm755 "${srcdir}/${pkgname}/src/wg" "${pkgdir}/usr/bin/awg"
  install -Dm755 "${srcdir}/${pkgname}/src/wg-quick/linux.bash" "${pkgdir}/usr/bin/awg-quick"
  install -Dm644 "${srcdir}/${pkgname}/src/systemd/wg-quick.target" "${pkgdir}/usr/lib/systemd/system/awg-quick.target"
  install -Dm644 "${srcdir}/${pkgname}/src/systemd/wg-quick@.service" "${pkgdir}/usr/lib/systemd/system/awg-quick@.service"
  install -dm700 "${pkgdir}/etc/amneziawg"
  install -Dm600 "${srcdir}/config.exemple" "${pkgdir}/etc/amneziawg"
}

